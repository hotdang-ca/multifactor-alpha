<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO Waiting for authorizations</title>
  </head>
  <style type="text/css">
    * {
      font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
  </style>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    let uuid;
    const socket = io();
  </script>
  <body>
    <div>
      <p>
        <h2>Auth Code:</h2>
        <strong id="authUuid"></strong>
      </p>

      <p id="hasMetRequirements">
        Add some contacts to notify...
      </p>

      <div>
        <h2>Add authorizor</h2>
        <input type="text" id="to" placeholder="Add phone number..." />
        <button id="addButton">Add</button>
        <div id="add-phone-status"></div>
        <div id="authorizors"></div>
      </div>

      <div>
        <button id='requestAuths'>Send authorizations</button>
      </div>
      <p>
        <button id="doTheThing" style="display: none">Do the thing!</button>
      </p>
      <p id="auth-status" style="display: none">
        Received <span id="numAuthorizations"></span> out of <span id="requiredAuths"></span> authorizations.
      </p>
    </div>

    <script>
      const sendAuthsButton = document.getElementById('requestAuths');
      sendAuthsButton.addEventListener('click', () => {
        const auth = document.getElementById('authUuid').innerHTML;
        socket.emit('get-auth', JSON.stringify({ auth }));
      });

      const addButton = document.getElementById('addButton');
      addButton.addEventListener('click', () => {
        addAuthorizor();
      });

      const addAuthorizor = () => {
        const toInput = document.getElementById('to');
        fetch('/add-authorizers', {
          method: 'post',
          headers: {
            'Content-type': 'application/json'
          },
          body: JSON.stringify(
            {
              uuid,
              contact: {
                to: toInput.value,
              }
          })
        })
        .then((response) => {
          return response.json();
        })
        .then((data) => {
          toInput.value = '';

          const contactsDb = document.getElementById('authorizors');
          const statusDiv = document.getElementById('add-phone-status');

          // extract contacts we will inform
          const { contacts, status } = data;
          if (!contacts) {
            // it was an error, and has a status
            statusDiv.innerHTML = status;
            return;
          }


          contactsDb.innerHTML = '';
          statusDiv.innerHTML = status;
          contacts.forEach((contact) => {
            const authHtml = document.createElement('div');
            authHtml.innerHTML = contact.to;
            contactsDb.appendChild(authHtml);
          });
        })
        .catch((err) => {
          console.log(err);
        });
      };

      socket.emit('require-auth');

      // When the server sent our auths
      socket.on('auths-sent', (payload) => {
        console.log('auths are sent. now waiting.');
        document.getElementById('hasMetRequirements').innerHTML = 'Sent authorizations. Waiting...';
        document.getElementById('auth-status').style.display = 'block';
        document.getElementById('requestAuths').setAttribute('disabled', 'disabled');
      });

      socket.on('auths-failed', (payload) => {
        console.log('auths have failed.');
        document.getElementById('requestAuths').setAttribute('disabled', 'disabled');
        document.getElementById('hasMetRequirements').innerHTML = 'Error with authorizations';
      });

      // When an incoming Authorization comes in
      socket.on('auth-msg', (payload) => {
        console.log('Received auth-msg');

        const payloadObject = JSON.parse(payload);
        console.log(payloadObject);

        if (uuid === payloadObject.uuid) {
          // it's ours
          const { count, isMetRequirement } = payloadObject;
          document.getElementById('numAuthorizations').innerHTML = count;
          if (isMetRequirement) {
            document.getElementById('hasMetRequirements').innerHTML = 'You\'ve received the required amount of authorizations!';
            document.getElementById('doTheThing').style.display = "block";
          }
        }
      });

      // we've received a response from server that we have an auth code
      socket.on('got-uuid', (payload) => {
        const uuidPayload = JSON.parse(payload);
        uuid = uuidPayload.uuid;

        document.getElementById('authUuid').innerHTML = uuidPayload.uuid;
        document.getElementById('numAuthorizations').innerHTML = 'none';
        document.getElementById('requiredAuths').innerHTML = uuidPayload.required;
      });
    </script>
  </body>
</html>
